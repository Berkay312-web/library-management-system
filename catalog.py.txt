import json
import os


def load_books(path: str) -> list:
    if not os.path.exists(path):
        return []

    with open(path, "r", encoding="utf-8") as file:
        return json.load(file)


def save_books(path: str, books: list) -> None:
    with open(path, "w", encoding="utf-8") as file:
        json.dump(books, file, indent=4, ensure_ascii=False)


def add_book(books: list, book_data: dict) -> dict:
    books.append(book_data)
    return book_data


def update_book(books: list, isbn: str, updates: dict) -> dict:
    for book in books:
        if book.get("isbn") == isbn:
            book.update(updates)
            return book
    return {}


def search_books(books: list, keyword: str) -> list:
    keyword = keyword.lower()

    found_books = []
    for book in books:
        if keyword in book["title"].lower() or keyword in book["author"].lower():
            found_books.append(book)

    return found_books


def filter_books(books: list, *, genre: str | None = None, year: int | None = None) -> list:
    result = books

    if genre is not None:
        result = [book for book in result if book["genre"] == genre]

    if year is not None:
        result = [book for book in result if book["publication_year"] == year]

    return result
